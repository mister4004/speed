Архитектура Cloud-Hosts Network Diagnostics Tool
1. Основные компоненты системы
Компонент	Расположение	Назначение
Ядро приложения	server.js	Точка входа, инициализация сервера, подключение middleware
Конфигурация	config/config.js	Централизованное хранение всех настроек приложения
Маршрутизация	routes/apiRoutes.js	Основной роутер API, распределение запросов по контроллерам
Контроллеры	controllers/*.js	Обработка бизнес-логики для конкретных endpoint'ов
Middleware	middleware/*.js	Промежуточная обработка запросов (безопасность, валидация, ошибки)
Утилиты	utils/*.js	Вспомогательные функции (валидация, логирование, кэширование)
WebSocket	websocket/index.js	Обработка real-time соединений (traceroute, speedtest)
Клиентское приложение	frontend/	React-приложение для взаимодействия с пользователем
Документация	docs/swagger.js	OpenAPI спецификация для API документации
2. Поток обработки HTTP-запроса
Diagram
Code
graph TD
    A[Запрос] --> B[server.js]
    B --> C[Глобальные Middleware]
    C --> D{Является ли WebSocket?}
    D -- Да --> E[WebSocket Handler]
    D -- Нет --> F[apiRoutes.js]
    F --> G[Специфичные Middleware]
    G --> H[Валидация]
    H --> I[Контроллер]
    I --> J[Обработка бизнес-логики]
    J --> K[Формирование ответа]
    K --> L{Ошибка?}
    L -- Да --> M[errorHandler]
    L -- Нет --> N[Отправка ответа]
3. Поток обработки WebSocket
Diagram
Code
graph TD
    A[Клиент] --> B[Установка соединения]
    B --> C[server.js]
    C --> D[websocket/index.js]
    D --> E{Тип операции}
    E -- Traceroute --> F[TracerouteController]
    E -- SpeedTest --> G[SpeedTestController]
    F/G --> H[Стриминг данных]
    H --> I[Клиент]
4. Ключевые функциональные модули
4.1. Безопасность
Rate Limiting: Ограничение запросов (общее, для ресурсоёмких операций, для speedtest)

Helmet: Защитные HTTP-заголовки

CORS: Контроль доступа для доверенных доменов

Валидация: Строгая проверка всех входных данных

4.2. Диагностические инструменты
Инструмент	Контроллер	Особенности
SpeedTest	speedTestController.js	Многопоточная загрузка/выгрузка до 300MB
MAC Lookup	macController.js	3-уровневый поиск (локальный + API fallback)
Геолокация	clientInfoController.js	Определение IP + характеристик устройства
Traceroute	tracerouteController.js	Real-time стриминг через WebSocket
DNS Tools	dnsController.js	Поддержка DNS-over-HTTPS
4.3. Оптимизации
Кэширование: NodeCache для часто запрашиваемых данных (MAC, DNS)

Сжатие: Gzip для всех ответов, кроме speedtest

Пул потоков: Для CPU-интенсивных операций

Логирование: Минималистичное ротируемое логирование

5. Система логирования
plaintext
[2025-06-28T12:34:56.789Z] INFO: 94.158.60.189 POST /api/mac-lookup 200 15ms
[2025-06-28T12:35:01.234Z] INFO: Client info saved: session123 (UZ, Tashkent)
[2025-06-28T12:35:05.678Z] ERROR: MAC lookup failed: Timeout
Уровни:

INFO: Базовые операции

WARN: Подозрительная активность

ERROR: Критические сбои

DEBUG: Детальная отладка (только в development)

6. Хранение данных
Тип данных	Метод хранения	Расположение
Клиентская информация	JSON-файлы (ротируемые)	logs/client-info/
Кэш приложения	In-memory (NodeCache)	Оперативная память
Конфигурация	JS-модуль	config/config.js
Логи сервера	Ротируемые файлы	logs/minimal.log
7. Особенности реализации
Гибкая конфигурация:

Все параметры вынесены в config.js

Возможность настройки без изменения кода

Модульность:

Чёткое разделение на контроллеры/сервисы

Возможность отключать модули (например, WebRTC)

Безопасность:

Валидация всех входных данных

Фильтрация чувствительной информации в логах

Автоматическое обновление зависимостей

Производительность:

Асинхронная обработка I/O-операций

Кэширование ресурсоёмких запросов

Оптимизированные алгоритмы сетевых проверок

8. Развёртывание и обслуживание
bash
# Запуск в production
npm run start

# Запуск в development
npm run dev

# Мониторинг
pm2 logs cloud-hosts-backend

# Тестирование
npm run test

# Обновление зависимостей
npm update --audit
Переменные окружения:

PORT: Порт сервера (по умолчанию 3001)

HOST: Хост сервера (по умолчанию 0.0.0.0)

NODE_ENV: Режим работы (production/development)

Рекомендации для новых разработчиков:
Начните с server.js - центральная точка инициализации

Изучите config.js - все настройки системы в одном месте

Тестируйте через Swagger - http://localhost:3001/api/v1/docs

Мониторьте логи - ключевой источник информации

Соблюдайте стиль кода - единый стиль для всего проекта

Эта документация полностью отражает текущую архитектуру системы и все ключевые компоненты, добавленные в процессе разработки.
